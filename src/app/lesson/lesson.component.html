<nb-layout>
  <nb-layout-column>
    
    <!-- Dashboard Header -->
    <div class="dashboard-header">
     <div class="breadbtn"> 
  <div class="breadcrumbs">
    <app-breadcrumb></app-breadcrumb>   <!-- ❌ Breadcrumb items stack vertically -->
  </div>
      
      <div class="header-actions">
      <button nbButton status="primary" (click)="addLesson()" class="primary">+ Add lesson</button></div></div>

      <div class="search-container">
        <label class="search-label">Filter Lessons By :</label>
        <div class="search-input-wrapper">
          <input 
  nbInput
         fullWidth
         fieldSize="small"
            
            placeholder="Search"
            [(ngModel)]="searchTerm"
            (ngModelChange)="updateFilter()" />

          <nb-icon icon="search-outline" pack="eva" class="search-icon"></nb-icon>
        </div>
      </div>
    </div>

<!-- Add/Edit Lesson Popup -->
<div class="popup-overlay" *ngIf="showForm">
  <div class="popup-form">
    <h2>{{ editingLesson ? 'Edit Lesson' : 'Add Lesson' }}</h2>
    <form [formGroup]="lessonForm" (ngSubmit)="saveLesson()">

      <!-- Lesson Type Select -->
      <label>Lesson Type*</label>
      <nb-select placeholder="-- Select Type --" fullWidth fieldSize="small"
                 formControlName="type">
        <nb-option value="Video">Video</nb-option>
        <nb-option value="Document">Document</nb-option>
      </nb-select>
      <div class="error" *ngIf="lessonForm.get('type')?.touched && lessonForm.get('type')?.invalid">
        Lesson type is required.
      </div>

      <!-- Video Upload -->
      <label *ngIf="lessonForm.get('type')?.value === 'Video'">Upload Video*</label>
      <label class="custom-file-upload" *ngIf="lessonForm.get('type')?.value === 'Video'">
        <input type="file"
               nbInput
               fullWidth
               fieldSize="small"
               accept="video/*"
               (change)="onFileSelected($event, 'video')" />
        <span class="doc-text">
          <nb-icon icon="video-outline"></nb-icon>
          {{ lessonForm.get('videoFileName')?.value || 'Choose Video' }}
        </span>
      </label>
      <div class="error" *ngIf="lessonForm.get('type')?.value === 'Video' && lessonForm.get('videoUrl')?.touched && lessonForm.get('videoUrl')?.invalid">
        Video is required.
      </div>

      <!-- Document Upload -->
      <label *ngIf="lessonForm.get('type')?.value === 'Document'">Upload Document*</label>
      <label class="custom-file-upload" *ngIf="lessonForm.get('type')?.value === 'Document'">
        <input type="file"
               nbInput
               fullWidth
               fieldSize="small"
               accept=".pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .txt"
               (change)="onFileSelected($event, 'document')" />
        <span class="doc-text">
          <nb-icon icon="file-text-outline"></nb-icon>
          {{ lessonForm.get('documentFileName')?.value || 'Choose Document' }}
        </span>
      </label>
      <div class="error" *ngIf="lessonForm.get('type')?.value === 'Document' && lessonForm.get('document')?.touched && lessonForm.get('document')?.invalid">
        Document is required.
      </div>

      <!-- Lesson Image -->
      <label>Lesson Image*</label>
      <label class="custom-file-upload">
        <input type="file"
               nbInput
               fullWidth
               fieldSize="small"
               accept="image/*"
               (change)="onFileSelected($event, 'image')" />
        <span class="doc-text">
          <nb-icon icon="image-outline"></nb-icon>
          {{ lessonForm.get('imageFileName')?.value || 'Choose Image' }}
        </span>
      </label>
      <div class="error" *ngIf="lessonForm.get('image')?.touched && lessonForm.get('image')?.invalid">
        Image is required.
      </div>

      <!-- Title -->
      <label>Title*</label>
      <input type="text" nbInput fullWidth fieldSize="small"
             placeholder="Enter Title"
             formControlName="title" />
      <div class="error" *ngIf="lessonForm.get('title')?.touched && lessonForm.get('title')?.invalid">
        <div *ngIf="lessonForm.get('title')?.errors?.['required']">Title is required.</div>
        <div *ngIf="lessonForm.get('title')?.errors?.['minlength']">Minimum 3 characters required.</div>
        <div *ngIf="lessonForm.get('title')?.errors?.['maxlength']">Maximum 50 characters allowed.</div>
      </div>

      <!-- Description -->
      <label>Description*</label>
      <textarea nbInput fullWidth rows="3" formControlName="description"></textarea>
      <div class="error" *ngIf="lessonForm.get('description')?.touched && lessonForm.get('description')?.invalid">
        <div *ngIf="lessonForm.get('description')?.errors?.['required']">Description is required.</div>
        <div *ngIf="lessonForm.get('description')?.errors?.['minlength']">Minimum 10 characters required.</div>
      </div>

      <!-- Attachments (Optional) -->
      <label>Attachments (Optional)</label>
      <label class="custom-file-upload">
        <input type="file" nbInput fullWidth fieldSize="small" multiple (change)="onFileSelected($event, 'attachments')" />
        <span>
          <nb-icon icon="paper-plane-outline"></nb-icon>
{{ lessonForm.get('attachments')?.value?.length 
     ? (lessonForm.get('attachments')?.value[0].name + 
        (lessonForm.get('attachments')?.value.length > 1 
          ? ' +' + (lessonForm.get('attachments')?.value.length - 1) + ' more' 
          : '')) 
     : 'Choose Files (Max 5, 20MB each)' }}


        </span>
      </label>

      <!-- Summary -->
      <label>Summary</label>
      <input nbInput fullWidth formControlName="summary" />

      <!-- Duration -->
      <label>Duration (minutes)*</label>
      <input nbInput type="number" fullWidth formControlName="duration" />
      <div class="error" *ngIf="lessonForm.get('duration')?.touched && lessonForm.get('duration')?.invalid">
        <div *ngIf="lessonForm.get('duration')?.errors?.['required']">Duration is required.</div>
        <div *ngIf="lessonForm.get('duration')?.errors?.['min']">Minimum 1 minute required.</div>
        <div *ngIf="lessonForm.get('duration')?.errors?.['max']">Maximum 300 minutes allowed.</div>
      </div>

      <!-- Order Index -->
      <label>Order Index*</label>
      <input nbInput type="number" fullWidth formControlName="orderIndex" />
      <div class="error" *ngIf="lessonForm.get('orderIndex')?.touched && lessonForm.get('orderIndex')?.invalid">
        <div *ngIf="lessonForm.get('orderIndex')?.errors?.['required']">Order index is required.</div>
        <div *ngIf="lessonForm.get('orderIndex')?.errors?.['min']">Order index must be at least 1.</div>
      </div>

      <!-- Action Buttons -->
      <div class="actions">
        <button nbButton status="basic" type="button" (click)="cancel()">Cancel</button>
        <button nbButton status="success" type="submit" [disabled]="lessonForm.invalid">Save</button>
      </div>

    </form>
  </div>
</div>


    <!-- Lessons List -->
    <div class="lessons-container">
      <nb-card *ngFor="let lesson of filteredLessons" class="lesson-card">
        <div class="badge" [ngClass]="lesson.type.toLowerCase()">{{ lesson.type }}</div>
        <nb-card-header>
          <img *ngIf="lesson.image" [src]="lesson.image" class="lesson-image" />
        </nb-card-header>
        <nb-card-body>
          <h5>{{ lesson.title }}</h5>
          <p>{{ lesson.description }}</p>
          <div class="lesson-meta">
            <nb-icon *ngIf="lesson.type === 'Video'" icon="video-outline" class="tiny-icon"></nb-icon>
            <nb-icon *ngIf="lesson.type === 'Document'" icon="book-outline" class="tiny-icon"></nb-icon>
            <span>Lesson {{ lesson.orderIndex }} • {{ lesson.duration }} min</span>
          </div>
        </nb-card-body>
        <nb-card-footer class="footer-actions">
          <!-- Actions -->
          <button nbButton class="icon-only" *ngIf="lesson.type === 'Video'" 
        (click)="playLessonVideo(lesson)"
        nbTooltip="Play Video" nbTooltipStatus="dark" nbTooltipPlacement="top">
  <nb-icon icon="play-circle-outline" class="tiny-icon3"></nb-icon>
</button>

<button nbButton class="icon-only" *ngIf="lesson.type === 'Document'" 
        (click)="openLessonDocument(lesson)"
        nbTooltip="Open Document" nbTooltipStatus="dark" nbTooltipPlacement="top">
  <nb-icon icon="file-text-outline" class="tiny-icon3"></nb-icon>
</button>

<button nbButton class="icon-only" 
        (click)="editLesson(lesson)"
        nbTooltip="Edit Lesson" nbTooltipStatus="dark" nbTooltipPlacement="top">
  <nb-icon icon="edit-outline" class="tiny-icon1"></nb-icon>
</button>

<button nbButton class="icon-only" 
        (click)="confirmDelete(lesson)"
        nbTooltip="Delete Lesson" nbTooltipStatus="dark" nbTooltipPlacement="top">
  <nb-icon icon="trash-2-outline" class="tiny-icon2"></nb-icon>
</button>
        </nb-card-footer>

      </nb-card>
    </div>

    <!-- Delete Confirmation -->
<div class="delete-overlay" *ngIf="showDeleteConfirm">
  <nb-card class="delete-card">
    <nb-card-header class="status-danger text-white">
      Warning
    </nb-card-header>

    <nb-card-body>
      Are you sure you want to delete 
      "<b>{{ lessonToDelete?.title }}</b>"?
    </nb-card-body>

    <nb-card-footer class="delete-actions">
      <button nbButton status="primary" (click)="cancelDelete()">No</button>
      <button nbButton status="primary" (click)="deleteLesson()">Yes</button>
    </nb-card-footer>
  </nb-card>
</div>




<div *ngIf="filteredLessons.length === 0;" class="no-lessons-container">
      <nb-icon icon="book-outline" pack="eva"></nb-icon>
      <p>No lessons available.</p>
    </div>
      </nb-layout-column>
</nb-layout>